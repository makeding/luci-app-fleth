#!/bin/ash
# Automatic fleth configuration on interface changes
# Runs 'fleth auto' when the uplink IPv6 interface comes up

h_ENABLED=$(uci get fleth.global.enabled 2>/dev/null)
h_UPLINK_INTERFACE=$(uci get fleth.global.interface6 2>/dev/null)
h_PREFER_SLAAC=$(uci get fleth.global.prefer_slaac 2>/dev/null)
h_TUNNEL_ACTIVATION=$(uci get fleth.global.tunnel_activation 2>/dev/null)

# Exit if fleth is not enabled or interface is not configured
[ "$h_ENABLED" != "1" ] && exit 0
[ -z "$h_UPLINK_INTERFACE" ] && exit 0

# Run fleth auto when the uplink interface comes up
if [ "$INTERFACE" = "$h_UPLINK_INTERFACE" ] && [ "$ACTION" = "ifup" ]; then
    logger -t fleth-hotplug "Interface $INTERFACE up, running fleth auto"
    /usr/sbin/fleth auto &
fi

# Connectivity test for tunnel interfaces
if [ "$h_TUNNEL_ACTIVATION" = "1" ] && [ "$ACTION" = "ifup" ]; then
    # Get interface protocol type
    proto=$(uci get network.${INTERFACE}.proto 2>/dev/null)

    # Check if protocol type requires tunnel activation
    case "$proto" in
        map|dslite|ipip6|ipip6h)
            logger -t fleth-hotplug "Interface $INTERFACE ($proto) detected, scheduling tunnel activation in 30 seconds"

            # Kill previous waiting process if exists
            PID_FILE="/var/run/fleth-tunnel-${INTERFACE}.pid"
            if [ -f "$PID_FILE" ]; then
                old_pid=$(cat "$PID_FILE" 2>/dev/null)
                if [ -n "$old_pid" ] && kill -0 "$old_pid" 2>/dev/null; then
                    logger -t fleth-hotplug "Killing previous tunnel activation process (PID: $old_pid)"
                    kill "$old_pid" 2>/dev/null
                fi
            fi

            # Non-blocking delayed ping to activate tunnel
            (
                # Save current process PID
                echo $$ > "$PID_FILE"

                sleep 30

                # Check if interface is still up
                if ! ifstatus ${INTERFACE} 2>/dev/null | jsonfilter -e '@.up' 2>/dev/null | grep -q true; then
                    logger -t fleth-hotplug "Interface $INTERFACE is no longer up, skipping tunnel activation"
                    rm -f "$PID_FILE"
                    exit 0
                fi

                # Get actual device name for the interface (l3_device is always available for tunnel interfaces)
                device=$(ifstatus ${INTERFACE} 2>/dev/null | jsonfilter -e '@.l3_device' 2>/dev/null)

                if [ -n "$device" ]; then
                    # Execute ping to activate tunnel (3 second timeout)
                    if ping -I "$device" 1.1.1.1 -c 1 -W 3 >/dev/null 2>&1; then
                        logger -t fleth-hotplug "Interface $INTERFACE ($proto) tunnel activated successfully"
                    else
                        logger -t fleth-hotplug "Interface $INTERFACE ($proto) tunnel activation attempted (no response)"
                    fi
                else
                    logger -t fleth-hotplug "Interface $INTERFACE ($proto) tunnel activation skipped (no device found)"
                fi

                rm -f "$PID_FILE"
            ) &
            ;;
    esac
fi

# Deprecate static /128 addresses to prioritize SLAAC
# This ensures SLAAC addresses are preferred over manually configured addresses
if [ "$h_PREFER_SLAAC" = "1" ] && { [ "$ACTION" = "ifup" ] || [ "$ACTION" = "ifupdate" ]; }; then
    device=$(ifstatus ${INTERFACE} 2>/dev/null | jsonfilter -e '@.device' 2>/dev/null)
    [ -z "$device" ] && device=$(ifstatus ${INTERFACE} 2>/dev/null | jsonfilter -e '@.l3_device' 2>/dev/null)
    if [ -n "$device" ]; then
        ip -6 addr show dev "$device" scope global 2>/dev/null | grep "inet6" | while read -r line; do
            addr=$(echo "$line" | awk '{print $2}')
            if echo "$addr" | grep -q "/128$"; then
                if ! echo "$line" | grep -q "dynamic"; then
                    clean_addr=$(echo "$addr" | cut -d'/' -f1)
                    ip -6 addr change "$clean_addr"/128 dev "$device" preferred_lft 0
                    logger -t fleth-hotplug "Deprecated static /128 address $clean_addr on $device (interface: $INTERFACE)"
                fi
            fi
        done
    fi
fi